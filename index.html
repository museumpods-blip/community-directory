<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Giving Hope – Community Directory</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body { font-family: Arial; background:#f4f4f4; margin:0; padding:15px; }
h1 { text-align:center; }
#map { height:350px; margin-bottom:20px; border-radius:8px; border:1px solid #ccc; }

form, .entry, .card {
  background:white;
  padding:15px;
  margin:10px auto;
  max-width:700px;
  border-radius:6px;
  box-shadow:0 0 6px rgba(0,0,0,0.1);
}

button {
  padding:8px 12px;
  background:#4CAF50;
  color:white;
  border:none;
  border-radius:4px;
  cursor:pointer;
  margin:3px 0;
}

button:hover { opacity:0.9; }

.tag {
  display:inline-block;
  padding:4px 8px;
  border-radius:999px;
  background:#e9f7ee;
  border:1px solid #cdebd7;
  font-size:12px;
  margin:2px;
}
</style>
</head>

<body>

<h1>Giving Hope in DuBois – Community Directory</h1>

<div id="map"></div>

<!-- SUBMIT FORM -->
<form id="orgForm">
  <h3>Submit Listing</h3>

  <input type="text" id="name" placeholder="Organization Name" required><br><br>
  <input type="text" id="types" placeholder="Type (Food, Shelter, etc)" required><br><br>
  <input type="text" id="location" placeholder="Full Address" required><br><br>
  <input type="text" id="contact" placeholder="Contact Info"><br><br>
  <textarea id="notes" placeholder="Description"></textarea><br><br>
  <input type="text" id="deleteKey" placeholder="Choose Delete Key" required><br><br>

  <button type="submit">Submit</button>
</form>

<div id="entries"></div>

<!-- PUBLIC DELETE -->
<div class="card">
  <h3>Delete My Listing</h3>

  <input type="text" id="deleteName" placeholder="Organization Name"><br><br>
  <input type="text" id="publicDeleteKey" placeholder="Your Delete Key"><br><br>

  <button onclick="deleteByKey()">Delete Listing</button>
</div>

<!-- ADMIN PANEL -->
<div class="card">
  <h3>Admin Panel</h3>
  <button onclick="adminLogin()">Admin Login</button>
  <div id="adminContent" style="margin-top:15px;"></div>
</div>

<script>
/* CONFIG */
const SUPABASE_URL = "https://jifbhauuqcsesscjshjl.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_jLRC9m1Kd28OJy1DOpqKCw_W93_A_4G";
const FUNCTION_URL = "https://jifbhauuqcsesscjshjl.supabase.co/functions/v1/submit-listing";
const ADMIN_PASSWORD = "Nittany2";

/* INIT */
const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const CENTER = [41.1197, -78.7603];
const RADIUS = 32186; // 20 miles

let map, markersLayer;

/* LOAD MAP */
document.addEventListener("DOMContentLoaded", async () => {

  map = L.map('map').setView(CENTER, 12);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'© OpenStreetMap'
  }).addTo(map);

  markersLayer = L.layerGroup().addTo(map);

  L.circle(CENTER, {
    radius: RADIUS,
    color: "blue",
    fillOpacity: 0.1
  }).addTo(map);

  loadListings();
});

/* LOAD APPROVED LISTINGS */
async function loadListings() {

  const { data } = await supabaseClient
    .from("listings")
    .select("*")
    .eq("approved", true);

  renderListings(data || []);
}

function renderListings(entries) {

  markersLayer.clearLayers();
  const container = document.getElementById("entries");
  container.innerHTML = "";

  entries.forEach(entry => {

    const tags = (entry.types || [])
      .map(t => `<span class="tag">${t}</span>`)
      .join("");

    const div = document.createElement("div");
    div.className = "entry";

    div.innerHTML = `
      <strong>${entry.name}</strong><br>
      ${tags}<br>
      ${entry.location}<br>
      ${entry.contact || ""}<br>
      ${entry.notes || ""}
    `;

    container.appendChild(div);

    if(entry.lat && entry.lng){
      L.marker([entry.lat, entry.lng])
        .addTo(markersLayer)
        .bindPopup(`<strong>${entry.name}</strong><br>${entry.location}`);
    }
  });
}

/* SUBMIT */
document.getElementById("orgForm").addEventListener("submit", async e => {

  e.preventDefault();

  const body = {
    name: document.getElementById("name").value,
    types: document.getElementById("types").value.split(",").map(t=>t.trim()),
    location: document.getElementById("location").value,
    contact: document.getElementById("contact").value,
    notes: document.getElementById("notes").value,
    deleteKey: document.getElementById("deleteKey").value
  };

  const res = await fetch(FUNCTION_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });

  alert(await res.text());
  e.target.reset();
});

/* PUBLIC DELETE */
async function deleteByKey() {

  const name = document.getElementById("deleteName").value.trim();
  const key = document.getElementById("publicDeleteKey").value.trim();

  if (!name || !key) {
    alert("Enter name and delete key.");
    return;
  }

  const hashBuffer = await crypto.subtle.digest(
    "SHA-256",
    new TextEncoder().encode(key)
  );

  const hash = Array.from(new Uint8Array(hashBuffer))
    .map(b => b.toString(16).padStart(2, "0"))
    .join("");

  const { error } = await supabaseClient
    .from("listings")
    .delete()
    .eq("name", name)
    .eq("delete_key_hash", hash);

  if (error) {
    alert("Delete failed.");
  } else {
    alert("Listing deleted.");
    loadListings();
  }
}

/* ADMIN */
function adminLogin() {
  const pw = prompt("Enter admin password:");
  if (pw === ADMIN_PASSWORD) {
    loadPending();
  } else {
    alert("Incorrect password");
  }
}

async function loadPending() {

  const { data } = await supabaseClient
    .from("listings")
    .select("*")
    .eq("approved", false);

  const container = document.getElementById("adminContent");
  container.innerHTML = "";

  if (!data.length) {
    container.innerHTML = "<p>No pending submissions.</p>";
    return;
  }

  data.forEach(entry => {

    const div = document.createElement("div");
    div.style.borderBottom = "1px solid #ddd";
    div.style.padding = "10px 0";

    div.innerHTML = `
      <strong>${entry.name}</strong><br>
      ${entry.location}<br><br>
      <button onclick="approveListing('${entry.id}')">Approve</button>
      <button onclick="adminDelete('${entry.id}')">Delete</button>
    `;

    container.appendChild(div);
  });
}

async function approveListing(id) {

  await supabaseClient
    .from("listings")
    .update({ approved: true })
    .eq("id", id);

  loadPending();
  loadListings();
}

async function adminDelete(id) {

  await supabaseClient
    .from("listings")
    .delete()
    .eq("id", id);

  loadPending();
  loadListings();
}
</script>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

</body>
</html>
