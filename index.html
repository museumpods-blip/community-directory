<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Giving Hope – Community Directory</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body { font-family: Arial; background:#f4f4f4; margin:0; padding:15px; }
#map { height:350px; margin-bottom:20px; border-radius:8px; border:1px solid #ccc; }
form,.entry,.filter-group,.admin-controls,.delete-section,.admin-login{
background:white;padding:15px;margin:10px auto;max-width:700px;
border-radius:6px;box-shadow:0 0 6px rgba(0,0,0,0.1);}
.entry{border-left:6px solid #4CAF50;margin-bottom:10px;}
button{margin-top:10px;padding:8px 12px;background:#4CAF50;color:white;border:none;border-radius:4px;cursor:pointer;}
button:hover{background:#45a049;}
.tag{display:inline-block;padding:4px 8px;border-radius:999px;background:#e9f7ee;border:1px solid #cdebd7;font-size:12px;color:#1f6a3a;margin:2px;}
</style>
</head>

<body>

<h1>Giving Hope DuBois – Community Directory</h1>
<div id="map"></div>

<div class="filter-group">
<button onclick="filterEntries('All')">All</button>
<button onclick="filterEntries('Shelter')">Shelter</button>
<button onclick="filterEntries('Food')">Food</button>
<button onclick="filterEntries('Warming Center')">Warming Center</button>
<button onclick="filterEntries('Clothing')">Clothing</button>
<button onclick="filterEntries('Hygiene Kits')">Hygiene Kits</button>
<button onclick="filterEntries('Other')">Other</button>
</div>

<div id="entries"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
let entries = [];
let map;
let markersLayer;
let currentFilter = "All";

const centerCoords = { lat: 41.1197, lon: -78.7603 };
const radiusMeters = 8046;

document.addEventListener("DOMContentLoaded", async () => {

  map = L.map('map').setView([centerCoords.lat, centerCoords.lon], 13);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'&copy; OpenStreetMap contributors'
  }).addTo(map);

  markersLayer = L.layerGroup().addTo(map);

  L.circle([centerCoords.lat, centerCoords.lon],{
    color:'blue',
    fillColor:'#99ccff',
    fillOpacity:0.2,
    radius:radiusMeters
  }).addTo(map);

  await loadData();
});

async function loadData(){
  try{
    const res = await fetch('data.json');
    const json = await res.json();
    entries = json.entries || [];
    renderEntries(currentFilter);
    addMarkers();
  }catch(err){
    console.error("Failed loading data.json",err);
  }
}

function renderEntries(filter){
  currentFilter = filter;
  const container = document.getElementById("entries");
  container.innerHTML = "";

  const filtered = entries.filter(e=>{
    return filter==="All" || (e.types && e.types.includes(filter));
  });

  filtered.forEach(entry=>{
    const tags = (entry.types||[]).map(t=>`<span class="tag">${t}</span>`).join("");

    const div = document.createElement("div");
    div.className="entry";
    div.innerHTML=`
      <strong>${escapeHtml(entry.name)}</strong><br>
      ${tags}<br>
      ${escapeHtml(entry.location)}<br>
      ${escapeHtml(entry.contact)}<br>
      <small>${escapeHtml(entry.notes||"")}</small>
    `;
    container.appendChild(div);
  });
}

async function addMarkers(){
  markersLayer.clearLayers();

  for(const entry of entries){
    try{
      const res = await fetch(
        "https://nominatim.openstreetmap.org/search?format=json&q="
        + encodeURIComponent(entry.location)
      );
      const data = await res.json();

      if(data.length>0){
        const lat=parseFloat(data[0].lat);
        const lon=parseFloat(data[0].lon);

        L.marker([lat,lon])
          .addTo(markersLayer)
          .bindPopup(`<strong>${escapeHtml(entry.name)}</strong><br>${escapeHtml(entry.location)}`);
      }
    }catch(e){}
  }
}

function filterEntries(type){
  renderEntries(type);
}

function escapeHtml(str){
  return String(str??"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
</script>

</body>
</html>
