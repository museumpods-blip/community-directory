<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Giving Hope – Community Directory</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body { font-family: Arial; background:#f4f4f4; margin:0; padding:15px; }
h1 { text-align:center; }
#map { height:350px; margin-bottom:20px; border-radius:8px; border:1px solid #ccc; }

form, .entry, .card {
  background:white;
  padding:15px;
  margin:10px auto;
  max-width:700px;
  border-radius:6px;
  box-shadow:0 0 6px rgba(0,0,0,0.1);
}

button {
  padding:8px 12px;
  background:#4CAF50;
  color:white;
  border:none;
  border-radius:4px;
  cursor:pointer;
  margin:3px 0;
}

button:hover { opacity:0.9; }

.tag {
  display:inline-block;
  padding:4px 8px;
  border-radius:999px;
  background:#e9f7ee;
  border:1px solid #cdebd7;
  font-size:12px;
  margin:2px;
}
</style>
</head>

<body>

<h1>Giving Hope in DuBois – Community Directory</h1>

<div id="map"></div>

<form id="orgForm">
  <h3>Submit Listing</h3>
  <input type="text" id="name" placeholder="Organization Name" required><br><br>
  <input type="text" id="types" placeholder="Type (Food, Shelter, etc)" required><br><br>
  <input type="text" id="location" placeholder="Full Address" required><br><br>
  <input type="text" id="contact" placeholder="Contact Info"><br><br>
  <textarea id="notes" placeholder="Description"></textarea><br><br>
  <input type="text" id="deleteKey" placeholder="Choose Delete Key" required><br><br>
  <button type="submit">Submit</button>
</form>

<div id="entries"></div>

<div class="card">
  <h3>Delete My Listing</h3>
  <input type="text" id="deleteName" placeholder="Organization Name"><br><br>
  <input type="text" id="publicDeleteKey" placeholder="Your Delete Key"><br><br>
  <button onclick="deleteByKey()">Delete Listing</button>
</div>

<script>
const SUPABASE_URL = "https://jifbhauuqcsesscjshjl.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_jLRC9m1Kd28OJy1DOpqKCw_W93_A_4G";

const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const CENTER = [41.1197, -78.7603];
let map, markersLayer;

document.addEventListener("DOMContentLoaded", async () => {

  map = L.map('map').setView(CENTER, 12);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'© OpenStreetMap'
  }).addTo(map);

  markersLayer = L.layerGroup().addTo(map);

  loadListings();
});

async function loadListings() {
  const { data } = await supabaseClient
    .from("listings")
    .select("*")
    .eq("approved", true);

  renderListings(data || []);
}

function renderListings(entries) {

  markersLayer.clearLayers();
  const container = document.getElementById("entries");
  container.innerHTML = "";

  entries.forEach(entry => {

    const tags = (entry.types || [])
      .map(t => `<span class="tag">${t}</span>`)
      .join("");

    const div = document.createElement("div");
    div.className = "entry";

    div.innerHTML = `
      <strong>${entry.name}</strong><br>
      ${tags}<br>
      ${entry.location || ""}<br>
      ${entry.contact || ""}<br>
      ${entry.notes || ""}
    `;

    container.appendChild(div);

    if(entry.lat && entry.lng){
      L.marker([entry.lat, entry.lng])
        .addTo(markersLayer)
        .bindPopup(`<strong>${entry.name}</strong><br>${entry.location}`);
    }
  });
}

/* DIRECT SUBMIT */
document.getElementById("orgForm").addEventListener("submit", async e => {

  e.preventDefault();

  const { error } = await supabaseClient
    .from("listings")
    .insert({
      name: document.getElementById("name").value,
      types: document.getElementById("types").value.split(",").map(t=>t.trim()),
      location: document.getElementById("location").value,
      contact: document.getElementById("contact").value,
      notes: document.getElementById("notes").value,
      delete_key: document.getElementById("deleteKey").value,
      approved: false
    });

  if (error) {
    alert("Submit failed: " + error.message);
    return;
  }

  alert("Submission received.");
  e.target.reset();
});

/* SIMPLE DELETE */
async function deleteByKey() {

  const name = document.getElementById("deleteName").value.trim();
  const key = document.getElementById("publicDeleteKey").value.trim();

  if (!name || !key) {
    alert("Enter name and delete key.");
    return;
  }

  const { data, error } = await supabaseClient
    .from("listings")
    .delete()
    .eq("name", name)
    .eq("delete_key", key)
    .select();

  if (error) {
    alert("Delete failed: " + error.message);
    return;
  }

  if (!data || data.length === 0) {
    alert("No matching listing found.");
    return;
  }

  alert("Listing deleted.");
  loadListings();
}
</script>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

</body>
</html>
