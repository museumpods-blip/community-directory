<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Giving Hope – Community Directory</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body{font-family:Arial;background:#f4f4f4;margin:0;padding:15px;}
h1{text-align:center;}
#map{height:350px;margin-bottom:20px;border-radius:8px;border:1px solid #ccc;}
.entry{
background:white;
padding:15px;
margin:10px auto;
max-width:700px;
border-radius:6px;
box-shadow:0 0 6px rgba(0,0,0,0.1);
border-left:6px solid #4CAF50;
}
.tag{
display:inline-block;
padding:4px 8px;
border-radius:999px;
background:#e9f7ee;
border:1px solid #cdebd7;
font-size:12px;
color:#1f6a3a;
margin:2px;
}
</style>
</head>

<body>

<h1>Giving Hope DuBois – Community Directory</h1>
<div id="map"></div>
<div id="entries"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
let map, markersLayer;
let entries = [];

document.addEventListener("DOMContentLoaded", async () => {
  map = L.map('map').setView([41.1197,-78.7603],13);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'© OpenStreetMap'
  }).addTo(map);

  markersLayer = L.layerGroup().addTo(map);

  await loadData();
});

async function loadData(){
  const res = await fetch("data.json?v=" + Date.now());
  const json = await res.json();
  entries = json.entries || [];
  renderEntries();
  addMarkers();
}

function renderEntries(){
  const container = document.getElementById("entries");
  container.innerHTML = "";

  entries.forEach(entry => {
    const tags = (entry.types || [])
      .map(t => `<span class="tag">${escapeHtml(t)}</span>`)
      .join("");

    const div = document.createElement("div");
    div.className = "entry";
    div.innerHTML = `
      <strong>${escapeHtml(entry.name)}</strong><br>
      ${tags}<br>
      ${escapeHtml(entry.location)}<br>
      ${escapeHtml(entry.contact || "")}<br>
      <small>${escapeHtml(entry.notes || "")}</small>
    `;
    container.appendChild(div);
  });
}

function addMarkers(){
  markersLayer.clearLayers();

  entries.forEach(entry => {
    if(entry.lat && entry.lng){
      L.marker([entry.lat, entry.lng])
        .addTo(markersLayer)
        .bindPopup(`<strong>${escapeHtml(entry.name)}</strong><br>${escapeHtml(entry.location)}`);
    }
  });
}

function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
</script>

</body>
</html>
